<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="UTF-8">
        <script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.7/require.min.js"></script>
    </head>
    <body>

        <textarea id="coeffs_3_2">
   1.5469e-04
  -9.1504e-19
  -2.0679e-04
  -2.3591e-04
   2.4186e-18
   3.0076e-04
   3.3667e-04
   1.2739e-18
  -4.1599e-04
  -4.5960e-04
   2.8548e-19
   5.5526e-04
   6.0752e-04
  -2.9997e-18
  -7.2149e-04
  -7.8343e-04
   7.2033e-18
   9.1784e-04
   9.9056e-04
  -1.3282e-17
  -1.1477e-03
  -1.2323e-03
  -1.8887e-21
   1.4145e-03
   1.5124e-03
  -6.3944e-18
  -1.7223e-03
  -1.8347e-03
   1.5463e-17
   2.0752e-03
   2.2036e-03
   1.0585e-17
  -2.4776e-03
  -2.6236e-03
  -1.5741e-18
   2.9345e-03
   3.0998e-03
  -1.1105e-17
  -3.4513e-03
  -3.6379e-03
   2.8183e-17
   4.0339e-03
   4.2440e-03
  -5.0494e-17
  -4.6893e-03
  -4.9252e-03
  -5.8565e-18
   5.4251e-03
   5.6897e-03
  -1.6869e-17
  -6.2503e-03
  -6.5470e-03
   4.6541e-17
   7.1756e-03
   7.5083e-03
  -1.9992e-17
  -8.2136e-03
  -8.5872e-03
  -1.5244e-17
   9.3797e-03
   9.8001e-03
  -2.3163e-17
  -1.0693e-02
  -1.1168e-02
   7.2581e-17
   1.2178e-02
   1.2716e-02
  -2.6288e-17
  -1.3866e-02
  -1.4480e-02
  -3.4239e-17
   1.5797e-02
   1.6504e-02
  -2.9266e-17
  -1.8027e-02
  -1.8849e-02
   1.1155e-16
   2.0631e-02
   2.1599e-02
  -3.1995e-17
  -2.3716e-02
  -2.4877e-02
   3.3236e-17
   2.7440e-02
   2.8861e-02
  -3.4380e-17
  -3.2042e-02
  -3.3832e-02
   3.5416e-17
   3.7907e-02
   4.0244e-02
  -3.6335e-17
  -4.5691e-02
  -4.8897e-02
   3.7127e-17
   5.6617e-02
   6.1331e-02
  -3.7786e-17
  -7.3240e-02
  -8.0931e-02
   3.8306e-17
   1.0196e-01
   1.1690e-01
  -3.8680e-17
  -1.6451e-01
  -2.0604e-01
   3.8906e-17
   4.1314e-01
   8.2681e-01
   1.0000e+00
   8.2681e-01
   4.1314e-01
   3.8906e-17
  -2.0604e-01
  -1.6451e-01
  -3.8680e-17
   1.1690e-01
   1.0196e-01
   3.8306e-17
  -8.0931e-02
  -7.3240e-02
  -3.7786e-17
   6.1331e-02
   5.6617e-02
   3.7127e-17
  -4.8897e-02
  -4.5691e-02
  -3.6335e-17
   4.0244e-02
   3.7907e-02
   3.5416e-17
  -3.3832e-02
  -3.2042e-02
  -3.4380e-17
   2.8861e-02
   2.7440e-02
   3.3236e-17
  -2.4877e-02
  -2.3716e-02
  -3.1995e-17
   2.1599e-02
   2.0631e-02
   1.1155e-16
  -1.8849e-02
  -1.8027e-02
  -2.9266e-17
   1.6504e-02
   1.5797e-02
  -3.4239e-17
  -1.4480e-02
  -1.3866e-02
  -2.6288e-17
   1.2716e-02
   1.2178e-02
   7.2581e-17
  -1.1168e-02
  -1.0693e-02
  -2.3163e-17
   9.8001e-03
   9.3797e-03
  -1.5244e-17
  -8.5872e-03
  -8.2136e-03
  -1.9992e-17
   7.5083e-03
   7.1756e-03
   4.6541e-17
  -6.5470e-03
  -6.2503e-03
  -1.6869e-17
   5.6897e-03
   5.4251e-03
  -5.8565e-18
  -4.9252e-03
  -4.6893e-03
  -5.0494e-17
   4.2440e-03
   4.0339e-03
   2.8183e-17
  -3.6379e-03
  -3.4513e-03
  -1.1105e-17
   3.0998e-03
   2.9345e-03
  -1.5741e-18
  -2.6236e-03
  -2.4776e-03
   1.0585e-17
   2.2036e-03
   2.0752e-03
   1.5463e-17
  -1.8347e-03
  -1.7223e-03
  -6.3944e-18
   1.5124e-03
   1.4145e-03
  -1.8887e-21
  -1.2323e-03
  -1.1477e-03
  -1.3282e-17
   9.9056e-04
   9.1784e-04
   7.2033e-18
  -7.8343e-04
  -7.2149e-04
  -2.9997e-18
   6.0752e-04
   5.5526e-04
   2.8548e-19
  -4.5960e-04
  -4.1599e-04
   1.2739e-18
   3.3667e-04
   3.0076e-04
   2.4186e-18
  -2.3591e-04
  -2.0679e-04
  -9.1504e-19
   1.5469e-04
        </textarea>
        <script>

require.config({
  paths: {
    mathjs:  'https://cdnjs.cloudflare.com/ajax/libs/mathjs/14.0.1/math',
    wasmdsp: '../dist/WasmDSP',
    signal:  '../dist/modules/signal'
  }
});

require(['wasmdsp'], function (wasmdsp) {

  wasmdsp.modules = wasmdsp.modules || {};

  function start() {
    require(['signal'], function (signal) {
      wasmdsp.modules['signal'] = signal;
      wasmdsp.initialise(wasmdsp.modules, function () {
        impulseResponse();
      });
    });
  }

  function getCoeffs() {
    let coeffs = [];
    let lines = document.getElementById('coeffs_3_2').value.split('\n');
    for (let i=0; i<lines.length; i++) {
      let line = lines[i].trim();
      if (line.length>4) coeffs.push(parseFloat(line));
    }
    return coeffs;
  }

  function impulseResponse() {
    let cfuncs = wasmdsp.modules.signal.wasm.exports;
    let buffer = wasmdsp.modules.signal.wasm.exports.memory.buffer;

    // Put filter coefficients in WASM memory.
    let coeffs = getCoeffs();
    let ptr_coeffs = cfuncs.Buffer(coeffs.length);
    let buf_coeffs = new Float32Array(buffer, ptr_coeffs, coeffs.length);
    for (let i=0; i<coeffs.length; i++) buf_coeffs[i] = coeffs[i];

    // Create a buffer for the delay line. Must be filter size + max input length - 1.
    let ptr_delay_line = cfuncs.Buffer(coeffs.length + 128 - 1);

    // UpFIRDown_new(size_t P, size_t Q, const float* coeffs, size_t num_coeffs, float* buffer).
    let ptr = cfuncs.UpFIRDown_new(3, 2, ptr_coeffs, coeffs.length, ptr_delay_line)

    // Create a test input buffer.
    let ptr_x = cfuncs.Buffer(10);
    let buf_x = new Float32Array(buffer, ptr_x, 10);
    let vals = [1,0,0,0,0,0,0,0,0,0];
    for (let i=0; i<10; i++)buf_x[i] = vals[i];

    // Output buffer.
    let ptr_y = cfuncs.Buffer(20);
    let buf_y = new Float32Array(buffer, ptr_y, 20);

    // Run the resampler.
    let num_y = cfuncs.UpFIRDown_processBlock(ptr, ptr_x, ptr_y, buf_x.length)

    // Dump the output.
    let y = [...buf_y];
    y = y.slice(0,num_y);
    console.log(y);

    let output = [];
    output.push(...y);

    // Run sampler with zeros to complete complete response.
    for (let i=0; i<buf_x.length; i++) buf_x[i] = 0;
    for (let i=0; i<100; i++) {
      num_y = cfuncs.UpFIRDown_processBlock(ptr, ptr_x, ptr_y, buf_x.length)
      y = [...buf_y];
      y = y.slice(0,num_y);
      output.push(...y);
    }

    console.log(output);

    // Delete the resampler.
    cfuncs.UpFIRDown_delete(ptr);
  }

  start();
});

        </script>
    </body>
</html>
